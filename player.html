<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>GBA Player</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --accent: #ff3c78;
  --purple: #7b2ff7;
  --cyan:   #00e5ff;
  --bar:    #0c0c18;
  --border: #1e1e30;
  --text:   #e8e8f0;
  --muted:  #555570;
}

html, body {
  width: 100%; height: 100%;
  background: #000;
  overflow: hidden;
  -webkit-tap-highlight-color: transparent;
  font-family: -apple-system, system-ui, sans-serif;
}

/* ── TOP BAR ── */
#topbar {
  position: fixed; top: 0; left: 0; right: 0;
  height: 44px; z-index: 9999;
  background: var(--bar);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  padding: 0 0.6rem; gap: 0.5rem;
}
.tb-btn {
  border-radius: 6px; cursor: pointer;
  font-size: 0.72rem; font-weight: 600;
  padding: 0.3rem 0.65rem;
  display: flex; align-items: center; gap: 0.3rem;
  white-space: nowrap; flex-shrink: 0;
  text-decoration: none; transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}
#btn-back {
  background: rgba(255,60,120,0.1);
  border: 1px solid rgba(255,60,120,0.35);
  color: var(--accent);
}
#btn-back:hover  { background: rgba(255,60,120,0.2); }
#btn-back:active { background: var(--accent); color: #000; border-color: var(--accent); }

#btn-orient {
  background: rgba(123,47,247,0.1);
  border: 1px solid rgba(123,47,247,0.35);
  color: var(--purple);
}
#btn-orient:hover  { background: rgba(123,47,247,0.2); }
#btn-orient:active { background: var(--purple); color: #fff; }

#btn-fs {
  background: rgba(0,229,255,0.08);
  border: 1px solid rgba(0,229,255,0.25);
  color: var(--cyan);
  font-size: 1rem; padding: 0.2rem 0.5rem;
}
#btn-fs:hover  { background: rgba(0,229,255,0.18); }
#btn-fs:active { background: var(--cyan); color: #000; }

#game-title {
  flex: 1; font-size: 0.78rem; font-weight: 600;
  color: var(--text); overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap;
}

/* ── GAME WRAPPER ──
   EmulatorJS docs say: wrap #game in a div with explicit px dimensions.
   We use JS to set these based on window size.
── */
#game-area {
  position: fixed;
  top: 44px; left: 0; right: 0; bottom: 0;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}

/*
  CRITICAL: #ejs-wrapper must have explicit pixel width/height.
  Set by JS. EmulatorJS reads offsetWidth/offsetHeight from this.
*/
#ejs-wrapper {
  /* JS sets width/height as inline style */
  position: relative;
  background: #000;
}

/* #game must fill the wrapper exactly */
#game {
  width: 100%;
  height: 100%;
}

/* ── MOBILE LANDSCAPE via body class ── */
body.landscape #game-area {
  /* On mobile: rotate via JS transform */
}

/* ── SPINNER overlay (before EJS loads) ── */
#splash {
  position: absolute; inset: 0;
  background: #000;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 1rem; z-index: 10;
  pointer-events: none;
}
.spinner {
  width: 46px; height: 46px; border-radius: 50%;
  border: 3px solid #1a1a28;
  border-top-color: var(--accent);
  border-right-color: var(--purple);
  animation: spin 0.75s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.splash-txt {
  font-family: monospace; font-size: 0.6rem;
  color: var(--muted); letter-spacing: 0.12em;
  animation: blink 1s step-end infinite;
}
.splash-sub { font-family: monospace; font-size: 0.68rem; color: #222235; }
@keyframes blink { 50% { opacity: 0; } }

/* ── Floating back btn in mobile landscape ── */
#float-back {
  display: none;
  position: fixed;
  z-index: 9999;
  top: 8px; left: 8px;
  background: rgba(0,0,0,0.8);
  border: 1px solid rgba(255,60,120,0.5);
  color: var(--accent);
  font-size: 0.72rem; font-weight: 700;
  padding: 0.4rem 0.8rem;
  border-radius: 6px;
  text-decoration: none;
  backdrop-filter: blur(6px);
}
body.landscape #float-back { display: block; }
body.landscape #topbar      { display: none; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <a id="btn-back" class="tb-btn" href="gba-arcade.html">← Libreria</a>
  <div id="game-title">Caricamento...</div>
  <button id="btn-orient" class="tb-btn" onclick="toggleOrientation()">⟳ Landscape</button>
  <button id="btn-fs"     class="tb-btn" onclick="toggleFullscreen()">⛶</button>
</div>

<!-- Floating back (visible only in mobile landscape) -->
<a id="float-back" href="gba-arcade.html">← Esci</a>

<!-- GAME AREA -->
<div id="game-area">
  <!--
    IMPORTANT (from official docs):
    #game must be inside a wrapper with EXPLICIT px width+height.
    EmulatorJS uses offsetWidth/offsetHeight to size the canvas.
    Without these, canvas = 0x0 = black screen.
  -->
  <div id="ejs-wrapper">
    <div id="game"></div>
    <div id="splash">
      <div class="spinner"></div>
      <div class="splash-txt">Caricamento emulatore...</div>
      <div class="splash-sub">Potrebbe richiedere qualche secondo</div>
    </div>
  </div>
</div>

<!-- CONFIG — must be BEFORE loader.js -->
<script>
/* ── Read URL params ── */
const params  = new URLSearchParams(window.location.search);
const gameUrl = params.get('url')   || '';
const title   = params.get('title') || 'Gioco GBA';

document.getElementById('game-title').textContent = title;
document.title = title + ' — GBA Arcade';

/* ────────────────────────────────────────────────
   SET WRAPPER DIMENSIONS
   EmulatorJS needs explicit pixel width+height on
   the parent of #game. We calculate from window.
──────────────────────────────────────────────── */
function sizeWrapper() {
  const availW = window.innerWidth;
  const availH = window.innerHeight - 44; // subtract topbar

  // GBA aspect ratio = 3:2
  const ratio = 3 / 2;
  let w, h;

  if (availW / availH > ratio) {
    // Width-constrained by height
    h = availH;
    w = Math.round(h * ratio);
  } else {
    // Height-constrained by width
    w = availW;
    h = Math.round(w / ratio);
  }

  const wrapper = document.getElementById('ejs-wrapper');
  wrapper.style.width  = w + 'px';
  wrapper.style.height = h + 'px';
}

sizeWrapper();
window.addEventListener('resize', sizeWrapper);

/* ────────────────────────────────────────────────
   EMULATORJS GLOBALS
   Must be set before loader.js runs.
──────────────────────────────────────────────── */
var EJS_player          = '#game';
var EJS_core            = 'mgba';
var EJS_gameUrl         = gameUrl;
var EJS_pathtodata      = 'https://cdn.emulatorjs.org/stable/data/';
var EJS_startOnLoaded   = true;
var EJS_color           = '#7b2ff7';
var EJS_backgroundColor = '#000000';
var EJS_AdUrl           = '';

var EJS_onGameStart = function () {
  var s = document.getElementById('splash');
  if (s) s.style.display = 'none';
};

/* ── Orientation toggle ── */
let landscape = false;

function toggleOrientation() {
  landscape = !landscape;
  document.body.classList.toggle('landscape', landscape);
  const btn = document.getElementById('btn-orient');
  btn.textContent = landscape ? '⟳ Portrait' : '⟳ Landscape';

  if (landscape) {
    // Mobile: rotate game-area via transform
    if (window.innerWidth < 768) {
      const area = document.getElementById('game-area');
      const w = window.innerHeight - 0;  // rotated: height becomes width
      const h = window.innerWidth;
      area.style.width           = w + 'px';
      area.style.height          = h + 'px';
      area.style.top             = '0';
      area.style.transformOrigin = 'top left';
      area.style.transform       = `rotate(90deg) translateX(0) translateY(-100%)`;
      area.style.left            = '0';
      area.style.right           = 'auto';
      area.style.bottom          = 'auto';

      // Resize wrapper for landscape
      const wrapper = document.getElementById('ejs-wrapper');
      const ratio   = 3 / 2;
      const lw      = Math.min(w, Math.round(h * ratio));
      const lh      = Math.round(lw / ratio);
      wrapper.style.width  = lw + 'px';
      wrapper.style.height = lh + 'px';
    }
    try { screen.orientation.lock('landscape').catch(()=>{}); } catch(e) {}
  } else {
    // Back to portrait
    const area = document.getElementById('game-area');
    area.style.cssText = '';
    area.style.position = 'fixed';
    area.style.top      = '44px';
    area.style.left     = '0';
    area.style.right    = '0';
    area.style.bottom   = '0';
    area.style.background = '#000';
    area.style.display    = 'flex';
    area.style.alignItems = 'center';
    area.style.justifyContent = 'center';
    sizeWrapper();
    try { screen.orientation.unlock(); } catch(e) {}
  }
}

/* ── Fullscreen ── */
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(()=>{});
  } else {
    document.exitFullscreen().catch(()=>{});
  }
}
document.addEventListener('fullscreenchange', () => {
  document.getElementById('btn-fs').textContent = document.fullscreenElement ? '✕' : '⛶';
  sizeWrapper();
});
</script>

<!-- loader.js — STATIC tag (never inject dynamically) -->
<script src="https://cdn.emulatorjs.org/stable/data/loader.js"></script>

</body>
</html>
