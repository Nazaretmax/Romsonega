<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>GBA Player</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --accent: #ff3c78; --purple: #7b2ff7; --cyan: #00e5ff;
  --yellow: #ffb300; --bar: #0c0c18; --border: #1e1e30;
  --text: #e8e8f0; --muted: #555570;
}
html, body { width:100%; height:100%; background:#000; overflow:hidden; font-family:-apple-system,system-ui,sans-serif; -webkit-tap-highlight-color:transparent; }

/* â”€â”€ TOPBAR â”€â”€ */
#topbar {
  position:fixed; top:0; left:0; right:0; height:44px;
  background:var(--bar); border-bottom:1px solid var(--border);
  display:flex; align-items:center; padding:0 0.6rem; gap:0.4rem; z-index:9999;
}
.tb-btn {
  border-radius:6px; cursor:pointer; font-size:0.7rem; font-weight:600;
  padding:0.28rem 0.6rem; display:flex; align-items:center; gap:0.3rem;
  white-space:nowrap; flex-shrink:0; text-decoration:none; transition:all 0.15s;
  -webkit-tap-highlight-color:transparent; border:1px solid;
}
#btn-back   { background:rgba(255,60,120,0.1); border-color:rgba(255,60,120,0.35); color:var(--accent); }
#btn-orient { background:rgba(123,47,247,0.1); border-color:rgba(123,47,247,0.35); color:var(--purple); }
#btn-fs     { background:rgba(0,229,255,0.08); border-color:rgba(0,229,255,0.25);  color:var(--cyan); font-size:1rem; padding:0.2rem 0.45rem; }
#btn-log    { background:rgba(255,179,0,0.1);  border-color:rgba(255,179,0,0.3);   color:var(--yellow); }
#btn-back:active   { background:var(--accent); color:#000; }
#btn-orient:active { background:var(--purple); color:#fff; }
#btn-fs:active     { background:var(--cyan);   color:#000; }
#btn-log:active    { background:var(--yellow);  color:#000; }
#game-title { flex:1; font-size:0.75rem; font-weight:600; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* â”€â”€ GAME AREA â”€â”€ */
#game-area {
  position:fixed; top:44px; left:0; right:0; bottom:0;
  background:#000; display:flex; align-items:center; justify-content:center;
}
/* CRITICAL: ejs-wrapper needs explicit px size set by JS */
#ejs-wrapper { position:relative; background:#000; }
#game        { width:100%; height:100%; }

/* â”€â”€ SPLASH â”€â”€ */
#splash {
  position:absolute; inset:0; background:#000; z-index:10;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:1rem; pointer-events:none;
}
.spinner { width:46px; height:46px; border-radius:50%; border:3px solid #1a1a28; border-top-color:var(--accent); border-right-color:var(--purple); animation:spin 0.75s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
.splash-txt { font-family:monospace; font-size:0.58rem; color:var(--muted); letter-spacing:0.12em; animation:blink 1s step-end infinite; }
.splash-sub { font-family:monospace; font-size:0.68rem; color:#222235; }
@keyframes blink { 50%{opacity:0} }

/* â”€â”€ LANDSCAPE (mobile) â”€â”€ */
body.landscape #topbar      { display:none; }
body.landscape #float-back  { display:flex; }

#float-back {
  display:none; position:fixed; z-index:9999; top:8px; left:8px;
  background:rgba(0,0,0,0.85); border:1px solid rgba(255,60,120,0.5);
  color:var(--accent); font-size:0.72rem; font-weight:700;
  padding:0.4rem 0.8rem; border-radius:6px; text-decoration:none;
  backdrop-filter:blur(6px); align-items:center; gap:0.3rem;
}

/* â”€â”€ LOG PANEL â”€â”€ */
#log-panel {
  display:none; position:fixed; bottom:0; left:0; right:0; height:46vh;
  background:#05050e; border-top:2px solid var(--yellow);
  z-index:99999; flex-direction:column;
}
#log-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:5px 10px; background:#09091a; border-bottom:1px solid #1a1a28; flex-shrink:0;
}
#log-header span { font-family:monospace; font-size:11px; color:var(--yellow); letter-spacing:0.1em; }
#log-header div  { display:flex; gap:6px; }
.log-hbtn { font-size:10px; padding:2px 8px; border-radius:4px; cursor:pointer; border:1px solid; }
#log-list {
  flex:1; overflow-y:auto; padding:6px 10px;
  font-family:monospace; font-size:11px; line-height:1.6;
}
.log-entry { padding:2px 0; border-bottom:1px solid #0e0e1e; word-break:break-all; }
.log-entry .ts { opacity:0.35; margin-right:6px; }
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <a id="btn-back" class="tb-btn" href="gba-arcade.html">â† Libreria</a>
  <div id="game-title">Caricamento...</div>
  <button id="btn-orient" class="tb-btn" onclick="toggleOrientation()">âŸ³ Landscape</button>
  <button id="btn-fs"     class="tb-btn" onclick="toggleFullscreen()">â›¶</button>
  <button id="btn-log"    class="tb-btn" onclick="toggleLog()">ğŸ› LOG</button>
</div>

<!-- Mobile landscape back -->
<a id="float-back" href="gba-arcade.html">â† Esci</a>

<!-- LOG PANEL â€” must be in DOM BEFORE any script that uses it -->
<div id="log-panel">
  <div id="log-header">
    <span>ğŸ› DEBUG LOG</span>
    <div>
      <button class="log-hbtn" onclick="document.getElementById('log-list').innerHTML=''"
        style="background:rgba(255,68,68,0.15);border-color:rgba(255,68,68,0.3);color:#ff4444;">CLEAR</button>
      <button class="log-hbtn" onclick="toggleLog()"
        style="background:rgba(255,179,0,0.15);border-color:rgba(255,179,0,0.3);color:#ffb300;">âœ• CHIUDI</button>
    </div>
  </div>
  <div id="log-list"></div>
</div>

<!-- GAME AREA -->
<div id="game-area">
  <div id="ejs-wrapper">
    <!-- #game MUST exist before loader.js â€” EmulatorJS renders inside here -->
    <div id="game"></div>
    <div id="splash">
      <div class="spinner"></div>
      <div class="splash-txt">Caricamento emulatore...</div>
      <div class="splash-sub">Potrebbe richiedere qualche secondo</div>
    </div>
  </div>
</div>

<!--
  CONFIG SCRIPT â€” runs AFTER all DOM elements exist above,
  and BEFORE loader.js below.
-->
<script>
/* â”€â”€ URL params â”€â”€ */
var params  = new URLSearchParams(window.location.search);
var gameUrl = params.get('url')   || '';
var title   = params.get('title') || 'Gioco GBA';

document.getElementById('game-title').textContent = title;
document.title = title + ' â€” GBA Arcade';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   WRAPPER SIZING
   EmulatorJS needs explicit px width+height.
   We set them now and on every resize.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function sizeWrapper() {
  var availW = window.innerWidth;
  var availH = window.innerHeight - 44;
  var ratio  = 3 / 2; /* GBA aspect ratio */
  var w, h;
  if (availW / availH > ratio) { h = availH; w = Math.round(h * ratio); }
  else                          { w = availW; h = Math.round(w / ratio); }
  var wr = document.getElementById('ejs-wrapper');
  wr.style.width  = w + 'px';
  wr.style.height = h + 'px';
}
sizeWrapper();
window.addEventListener('resize', sizeWrapper);

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DEBUG LOG
   log-panel and log-list are already in DOM â†‘
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var logList = document.getElementById('log-list');
var logOpen = false;

function log(msg, type) {
  var colors = { ok:'#00ffa0', err:'#ff4444', warn:'#ffb300', info:'#00c8ff' };
  var t  = new Date().toLocaleTimeString('it', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  var d  = document.createElement('div');
  d.className = 'log-entry';
  d.style.color = colors[type] || '#aaaaaa';
  d.innerHTML   = '<span class="ts">' + t + '</span>' + msg;
  logList.appendChild(d);
  logList.scrollTop = logList.scrollHeight;
}

function toggleLog() {
  logOpen = !logOpen;
  document.getElementById('log-panel').style.display = logOpen ? 'flex' : 'none';
  document.getElementById('btn-log').textContent = logOpen ? 'âœ• LOG' : 'ğŸ› LOG';
}

/* Catch all JS errors */
window.addEventListener('error', function(e) {
  log('âŒ ' + e.message + ' [' + (e.filename||'').split('/').pop() + ':' + e.lineno + ']', 'err');
});
window.addEventListener('unhandledrejection', function(e) {
  log('âŒ Promise: ' + (e.reason && (e.reason.message || e.reason)), 'err');
});

/* Intercept console.error / warn */
var _ce = console.error;
console.error = function() { log('âŒ console.error: ' + Array.from(arguments).join(' '), 'err'); _ce.apply(console, arguments); };
var _cw = console.warn;
console.warn  = function() { log('âš  console.warn: '  + Array.from(arguments).join(' '), 'warn'); _cw.apply(console, arguments); };

/* Intercept fetch */
var _fetch = window.fetch;
window.fetch = function(url, opts) {
  var short = (typeof url === 'string') ? url.split('/').slice(-2).join('/') : String(url);
  log('ğŸ“¡ fetch â†’ ' + short, 'info');
  return _fetch.apply(this, arguments)
    .then(function(r) {
      log((r.ok ? 'âœ…' : 'âš ï¸') + ' HTTP ' + r.status + ' â† ' + short, r.ok ? 'ok' : 'warn');
      return r;
    })
    .catch(function(e) {
      log('âŒ fetch FAIL: ' + e.message + ' â† ' + short, 'err');
      throw e;
    });
};

/* Intercept XMLHttpRequest */
var _XHR = window.XMLHttpRequest;
window.XMLHttpRequest = function() {
  var xhr = new _XHR();
  var _open = xhr.open.bind(xhr);
  xhr.open = function(method, url) {
    var short = url.split('/').slice(-2).join('/');
    log('ğŸ“¡ XHR ' + method + ' â†’ ' + short, 'info');
    xhr.addEventListener('load',  function() { log((xhr.status < 400 ? 'âœ…' : 'âš ï¸') + ' HTTP ' + xhr.status + ' â† ' + short, xhr.status < 400 ? 'ok' : 'warn'); });
    xhr.addEventListener('error', function() { log('âŒ XHR FAIL â† ' + short, 'err'); });
    return _open(method, url);
  };
  return xhr;
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   EMULATORJS GLOBALS
   var declarations are required â€” no 'use strict'
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var EJS_player          = '#game';
var EJS_core            = 'mgba';
var EJS_gameUrl         = gameUrl;
var EJS_pathtodata      = 'https://cdn.emulatorjs.org/stable/data/';
var EJS_startOnLoaded   = true;
var EJS_color           = '#7b2ff7';
var EJS_backgroundColor = '#000000';
var EJS_AdUrl           = '';

var EJS_onGameStart = function() {
  log('ğŸ® EJS_onGameStart â†’ GIOCO AVVIATO!', 'ok');
  var s = document.getElementById('splash');
  if (s) s.style.display = 'none';
};

var EJS_onLoadError = function(e) {
  log('âŒ EJS_onLoadError â†’ ' + (e || 'errore sconosciuto'), 'err');
};

/* â”€â”€ Initial log â”€â”€ */
log('â”â”â” START â”â”â”', 'info');
log('ğŸ® Titolo: ' + title, 'info');
log('ğŸ”— ROM URL: ' + (gameUrl ? gameUrl.split('/').pop() : 'âš  NESSUNA URL!'), gameUrl ? 'info' : 'err');
log('ğŸ“¦ CDN: ' + EJS_pathtodata, 'info');
var wr = document.getElementById('ejs-wrapper');
log('ğŸ“ Wrapper: ' + wr.style.width + ' Ã— ' + wr.style.height, 'info');
log('â³ Caricamento loader.js...', 'info');

/* â”€â”€ Orientation â”€â”€ */
var landscape = false;
function toggleOrientation() {
  landscape = !landscape;
  document.body.classList.toggle('landscape', landscape);
  document.getElementById('btn-orient').textContent = landscape ? 'âŸ³ Portrait' : 'âŸ³ Landscape';
  log('ğŸ”„ Orientamento: ' + (landscape ? 'landscape' : 'portrait'), 'info');

  var area = document.getElementById('game-area');
  if (landscape && window.innerWidth < 769) {
    var lw = window.innerHeight;
    var lh = window.innerWidth;
    area.style.cssText = 'position:fixed;top:0;left:0;background:#000;display:flex;align-items:center;justify-content:center;';
    area.style.width           = lw + 'px';
    area.style.height          = lh + 'px';
    area.style.transformOrigin = 'top left';
    area.style.transform       = 'rotate(90deg) translateX(0) translateY(-100%)';
    var ratio = 3/2, rw = Math.min(lw, Math.round(lh*ratio)), rh = Math.round(rw/ratio);
    wr.style.width  = rw + 'px';
    wr.style.height = rh + 'px';
    try { screen.orientation.lock('landscape').catch(function(){}); } catch(e) {}
  } else {
    area.style.cssText = 'position:fixed;top:44px;left:0;right:0;bottom:0;background:#000;display:flex;align-items:center;justify-content:center;';
    sizeWrapper();
    try { screen.orientation.unlock(); } catch(e) {}
  }
}

/* â”€â”€ Fullscreen â”€â”€ */
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(function(e){ log('âš  Fullscreen: ' + e.message, 'warn'); });
  } else {
    document.exitFullscreen();
  }
}
document.addEventListener('fullscreenchange', function() {
  document.getElementById('btn-fs').textContent = document.fullscreenElement ? 'âœ•' : 'â›¶';
  sizeWrapper();
});
</script>

<!--
  loader.js MUST be a STATIC <script> tag.
  Never inject it with document.createElement('script').
-->
<script src="https://cdn.emulatorjs.org/stable/data/loader.js"
  onload="log('âœ… loader.js caricato!','ok')"
  onerror="log('âŒ loader.js FALLITO â€” CDN non raggiungibile','err')">
</script>

</body>
</html>
