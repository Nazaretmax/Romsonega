<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>GBA Player</title>
<style>
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
:root {
  --accent:#ff3c78; --purple:#7b2ff7; --cyan:#00e5ff;
  --yellow:#ffb300; --bar:#0c0c18; --border:#1e1e30;
  --text:#e8e8f0; --muted:#555570;
}
html,body { width:100%; height:100%; background:#000; overflow:hidden; font-family:-apple-system,system-ui,sans-serif; -webkit-tap-highlight-color:transparent; }

/* TOPBAR */
#topbar { position:fixed; top:0; left:0; right:0; height:44px; background:var(--bar); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 0.6rem; gap:0.4rem; z-index:9999; }
.tb-btn { border-radius:6px; cursor:pointer; font-size:0.7rem; font-weight:600; padding:0.28rem 0.6rem; display:flex; align-items:center; gap:0.3rem; white-space:nowrap; flex-shrink:0; text-decoration:none; transition:all 0.15s; -webkit-tap-highlight-color:transparent; border:1px solid; }
#btn-back   { background:rgba(255,60,120,0.1);  border-color:rgba(255,60,120,0.35); color:var(--accent); }
#btn-orient { background:rgba(123,47,247,0.1);  border-color:rgba(123,47,247,0.35); color:var(--purple); }
#btn-fs     { background:rgba(0,229,255,0.08);  border-color:rgba(0,229,255,0.25);  color:var(--cyan); font-size:1rem; padding:0.2rem 0.45rem; }
#btn-log    { background:rgba(255,179,0,0.1);   border-color:rgba(255,179,0,0.3);   color:var(--yellow); }
#btn-back:active   { background:var(--accent); color:#000; }
#btn-orient:active { background:var(--purple); color:#fff; }
#btn-fs:active     { background:var(--cyan);   color:#000; }
#btn-log:active    { background:var(--yellow);  color:#000; }
#game-title { flex:1; font-size:0.75rem; font-weight:600; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* GAME AREA */
#game-area { position:fixed; top:44px; left:0; right:0; bottom:0; background:#000; display:flex; align-items:center; justify-content:center; }
#ejs-wrapper { position:relative; background:#000; }
#game { width:100%; height:100%; }

/* SPLASH */
#splash { position:absolute; inset:0; background:#000; z-index:10; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.8rem; }
.spinner { width:46px; height:46px; border-radius:50%; border:3px solid #1a1a28; border-top-color:var(--accent); border-right-color:var(--purple); animation:spin 0.75s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }
#splash-status { font-family:monospace; font-size:0.58rem; color:var(--muted); letter-spacing:0.1em; text-align:center; padding:0 1rem; }
#splash-bar-wrap { width:240px; height:6px; background:#1a1a28; border-radius:3px; overflow:hidden; display:none; }
#splash-bar { height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--purple)); border-radius:3px; transition:width 0.3s; }
#splash-pct { font-family:monospace; font-size:0.55rem; color:var(--purple); }
@keyframes blink { 50%{opacity:0} }

/* LANDSCAPE mobile */
body.landscape #topbar     { display:none; }
body.landscape #float-back { display:flex; }
#float-back { display:none; position:fixed; z-index:9999; top:8px; left:8px; background:rgba(0,0,0,0.85); border:1px solid rgba(255,60,120,0.5); color:var(--accent); font-size:0.72rem; font-weight:700; padding:0.4rem 0.8rem; border-radius:6px; text-decoration:none; backdrop-filter:blur(6px); align-items:center; gap:0.3rem; }

/* LOG PANEL */
#log-panel { display:none; position:fixed; bottom:0; left:0; right:0; height:46vh; background:#05050e; border-top:2px solid var(--yellow); z-index:99999; flex-direction:column; }
#log-header { display:flex; align-items:center; justify-content:space-between; padding:5px 10px; background:#09091a; border-bottom:1px solid #1a1a28; flex-shrink:0; }
#log-header span { font-family:monospace; font-size:11px; color:var(--yellow); letter-spacing:0.1em; }
#log-header div  { display:flex; gap:6px; }
.log-hbtn { font-size:10px; padding:2px 8px; border-radius:4px; cursor:pointer; border:1px solid; background:transparent; }
#log-list { flex:1; overflow-y:auto; padding:6px 10px; font-family:monospace; font-size:11px; line-height:1.7; }
.le { padding:1px 0; border-bottom:1px solid #0a0a18; word-break:break-all; }
.le .ts { opacity:0.35; margin-right:5px; font-size:10px; }
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <a id="btn-back" class="tb-btn" href="gba-arcade.html">‚Üê Libreria</a>
  <div id="game-title">Caricamento...</div>
  <button id="btn-orient" class="tb-btn" onclick="toggleOrientation()">‚ü≥ Landscape</button>
  <button id="btn-fs"     class="tb-btn" onclick="toggleFullscreen()">‚õ∂</button>
  <button id="btn-log"    class="tb-btn" onclick="toggleLog()">üêõ LOG</button>
</div>

<a id="float-back" href="gba-arcade.html">‚Üê Esci</a>

<!-- LOG PANEL ‚Äî in DOM before any script -->
<div id="log-panel">
  <div id="log-header">
    <span>üêõ DEBUG LOG</span>
    <div>
      <button class="log-hbtn" onclick="document.getElementById('log-list').innerHTML=''"
        style="border-color:rgba(255,68,68,0.4);color:#ff4444;">CLEAR</button>
      <button class="log-hbtn" onclick="toggleLog()"
        style="border-color:rgba(255,179,0,0.4);color:#ffb300;">‚úï CHIUDI</button>
    </div>
  </div>
  <div id="log-list"></div>
</div>

<!-- GAME AREA -->
<div id="game-area">
  <div id="ejs-wrapper">
    <div id="game"></div>
    <div id="splash">
      <div class="spinner"></div>
      <div id="splash-status">Scaricamento ROM...</div>
      <div id="splash-bar-wrap"><div id="splash-bar"></div></div>
      <div id="splash-pct"></div>
    </div>
  </div>
</div>

<script>
/* ‚îÄ‚îÄ URL params ‚îÄ‚îÄ */
var params  = new URLSearchParams(window.location.search);
var gameUrl = params.get('url')   || '';
var title   = params.get('title') || 'Gioco GBA';

document.getElementById('game-title').textContent = title;
document.title = title + ' ‚Äî GBA Arcade';

/* ‚îÄ‚îÄ Wrapper sizing ‚îÄ‚îÄ */
function sizeWrapper() {
  var aW = window.innerWidth;
  var aH = window.innerHeight - 44;
  var r  = 3/2;
  var w, h;
  if (aW/aH > r) { h=aH; w=Math.round(h*r); }
  else            { w=aW; h=Math.round(w/r); }
  var wr = document.getElementById('ejs-wrapper');
  wr.style.width  = w+'px';
  wr.style.height = h+'px';
}
sizeWrapper();
window.addEventListener('resize', sizeWrapper);

/* ‚îÄ‚îÄ LOG ‚îÄ‚îÄ */
var logList = document.getElementById('log-list');
var logOpen = false;

function log(msg, type) {
  var colors = {ok:'#00ffa0',err:'#ff4444',warn:'#ffb300',info:'#00c8ff'};
  var t = new Date().toLocaleTimeString('it',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  var d = document.createElement('div');
  d.className   = 'le';
  d.style.color = colors[type]||'#aaa';
  d.innerHTML   = '<span class="ts">'+t+'</span>'+msg;
  logList.appendChild(d);
  logList.scrollTop = logList.scrollHeight;
}
function toggleLog() {
  logOpen = !logOpen;
  document.getElementById('log-panel').style.display = logOpen?'flex':'none';
  document.getElementById('btn-log').textContent = logOpen?'‚úï LOG':'üêõ LOG';
}

window.addEventListener('error',function(e){ log('‚ùå '+e.message+' ['+((e.filename||'').split('/').pop())+':'+e.lineno+']','err'); });
window.addEventListener('unhandledrejection',function(e){ log('‚ùå Promise: '+(e.reason&&(e.reason.message||e.reason)),'err'); });

var _ce=console.error; console.error=function(){ log('‚ùå '+Array.from(arguments).join(' '),'err'); _ce.apply(console,arguments); };
var _cw=console.warn;  console.warn =function(){ log('‚ö† ' +Array.from(arguments).join(' '),'warn');_cw.apply(console,arguments); };

/* ‚îÄ‚îÄ Orientation ‚îÄ‚îÄ */
var landscape = false;
function toggleOrientation() {
  landscape = !landscape;
  document.body.classList.toggle('landscape', landscape);
  document.getElementById('btn-orient').textContent = landscape?'‚ü≥ Portrait':'‚ü≥ Landscape';
  log('üîÑ '+(landscape?'Landscape':'Portrait'),'info');
  var area = document.getElementById('game-area');
  var wr   = document.getElementById('ejs-wrapper');
  if (landscape && window.innerWidth < 769) {
    var lw=window.innerHeight, lh=window.innerWidth;
    area.style.cssText='position:fixed;top:0;left:0;background:#000;display:flex;align-items:center;justify-content:center;';
    area.style.width=lw+'px'; area.style.height=lh+'px';
    area.style.transformOrigin='top left';
    area.style.transform='rotate(90deg) translateX(0) translateY(-100%)';
    var rw=Math.min(lw,Math.round(lh*1.5)), rh=Math.round(rw/1.5);
    wr.style.width=rw+'px'; wr.style.height=rh+'px';
    try{screen.orientation.lock('landscape').catch(function(){});}catch(e){}
  } else {
    area.style.cssText='position:fixed;top:44px;left:0;right:0;bottom:0;background:#000;display:flex;align-items:center;justify-content:center;';
    sizeWrapper();
    try{screen.orientation.unlock();}catch(e){}
  }
}

/* ‚îÄ‚îÄ Fullscreen ‚îÄ‚îÄ */
function toggleFullscreen() {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(function(e){log('‚ö† FS: '+e.message,'warn');});
  else document.exitFullscreen();
}
document.addEventListener('fullscreenchange',function(){
  document.getElementById('btn-fs').textContent = document.fullscreenElement?'‚úï':'‚õ∂';
  sizeWrapper();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN: Pre-fetch ROM as blob, then launch EmulatorJS
   
   WHY: Archive.org blocks XHR cross-origin (CORS),
   but allows fetch(). EmulatorJS uses XHR internally.
   Solution: download with fetch() ‚Üí create blob: URL
   ‚Üí give blob URL to EJS (XHR on blob: always works).
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
log('‚îÅ‚îÅ‚îÅ START ‚îÅ‚îÅ‚îÅ','info');
log('üéÆ '+title,'info');
log('üîó '+decodeURIComponent(gameUrl.split('/').pop()),'info');

function setSplashStatus(msg) {
  document.getElementById('splash-status').textContent = msg;
}

function startEmulatorWithBlob(blobUrl) {
  log('‚ñ∂ Avvio EmulatorJS con blob URL','info');
  setSplashStatus('Avvio emulatore...');

  /* EJS globals ‚Äî var required, no strict mode, set before loader.js */
  var EJS_player          = '#game';
  var EJS_core            = 'mgba';
  var EJS_gameUrl         = blobUrl;   /* ‚Üê blob URL, not archive.org */
  var EJS_pathtodata      = 'https://cdn.emulatorjs.org/stable/data/';
  var EJS_startOnLoaded   = true;
  var EJS_color           = '#7b2ff7';
  var EJS_backgroundColor = '#000000';
  var EJS_language        = 'en';      /* ‚Üê 'it' gives 404, use 'en' */
  var EJS_AdUrl           = '';

  var EJS_onGameStart = function() {
    log('üéÆ GIOCO AVVIATO!','ok');
    document.getElementById('splash').style.display = 'none';
  };
  var EJS_onLoadError = function(e) {
    log('‚ùå EJS_onLoadError: '+(e||'?'),'err');
  };

  /* Copy to window so loader.js finds them */
  window.EJS_player          = EJS_player;
  window.EJS_core            = EJS_core;
  window.EJS_gameUrl         = EJS_gameUrl;
  window.EJS_pathtodata      = EJS_pathtodata;
  window.EJS_startOnLoaded   = EJS_startOnLoaded;
  window.EJS_color           = EJS_color;
  window.EJS_backgroundColor = EJS_backgroundColor;
  window.EJS_language        = EJS_language;
  window.EJS_AdUrl           = EJS_AdUrl;
  window.EJS_onGameStart     = EJS_onGameStart;
  window.EJS_onLoadError     = EJS_onLoadError;

  log('üì¶ CDN: '+EJS_pathtodata,'info');
  log('‚è≥ Caricamento loader.js...','info');

  var s = document.createElement('script');
  s.src = 'https://cdn.emulatorjs.org/stable/data/loader.js';
  s.onload  = function(){ log('‚úÖ loader.js OK','ok'); };
  s.onerror = function(){ log('‚ùå loader.js FAIL ‚Äî CDN non raggiungibile','err'); setSplashStatus('‚ùå CDN non raggiungibile'); };
  document.head.appendChild(s);
}

/* CORS proxy list ‚Äî tried in order until one works */
var PROXIES = [
  '',                                          /* 1. diretto (funziona se CORS ok) */
  'https://corsproxy.io/?',                    /* 2. corsproxy.io */
  'https://api.allorigins.win/raw?url=',       /* 3. allorigins */
  'https://proxy.cors.sh/',                    /* 4. cors.sh */
];
var proxyIndex = 0;

function fetchWithProxy(romUrl, proxyPrefix) {
  var fetchUrl = proxyPrefix
    ? proxyPrefix + encodeURIComponent(romUrl)
    : romUrl;

  var label = proxyPrefix
    ? proxyPrefix.split('/')[2]   /* hostname only */
    : 'diretto';

  log('üì° Tentativo '+(proxyIndex+1)+'/'+PROXIES.length+' via '+label, 'info');
  setSplashStatus('Download ROM... ('+label+')');

  return fetch(fetchUrl, { mode: 'cors' })
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res;
    });
}

function downloadROM(url) {
  log('üì• Download ROM...','info');
  document.getElementById('splash-bar-wrap').style.display = 'block';

  function tryNext() {
    if (proxyIndex >= PROXIES.length) {
      log('‚ùå Tutti i proxy falliti.','err');
      setSplashStatus('‚ùå Impossibile scaricare la ROM');
      document.getElementById('splash-pct').style.color='#ff4444';
      document.getElementById('splash-pct').textContent='Errore CORS';
      return;
    }

    fetchWithProxy(url, PROXIES[proxyIndex])
      .then(function(res) {
        log('‚úÖ Risposta OK via proxy '+proxyIndex+' ‚Äî lettura bytes...','ok');
        var total = parseInt(res.headers.get('content-length')||'0');
        if (total) log('üì¶ '+(total/1024/1024).toFixed(1)+' MB','info');

        var reader   = res.body.getReader();
        var chunks   = [];
        var received = 0;

        function read() {
          return reader.read().then(function(r) {
            if (r.done) {
              log('‚úÖ Download completo: '+(received/1024/1024).toFixed(1)+' MB','ok');
              var blobUrl = URL.createObjectURL(new Blob(chunks));
              log('üîó Blob URL pronto','ok');
              startEmulatorWithBlob(blobUrl);
              return;
            }
            chunks.push(r.value);
            received += r.value.length;
            if (total) {
              var pct = Math.round(received/total*100);
              document.getElementById('splash-bar').style.width = pct+'%';
              document.getElementById('splash-pct').textContent = pct+'%';
              setSplashStatus('Download: '+pct+'%');
            } else {
              setSplashStatus('Download: '+(received/1024/1024).toFixed(1)+' MB...');
            }
            return read();
          });
        }
        return read();
      })
      .catch(function(e) {
        log('‚ö† Proxy '+proxyIndex+' fallito: '+e.message,'warn');
        proxyIndex++;
        tryNext();
      });
  }

  tryNext();
}

/* ‚îÄ‚îÄ Boot ‚îÄ‚îÄ */
if (!gameUrl) {
  log('‚ùå Nessuna URL passata!','err');
  setSplashStatus('‚ùå Nessuna ROM specificata');
} else {
  downloadROM(gameUrl);
}
</script>
</body>
</html>
