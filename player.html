<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>GBA Player</title>
<style>
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
:root {
  --accent:#ff3c78; --purple:#7b2ff7; --cyan:#00e5ff;
  --yellow:#ffb300; --bar:#0c0c18; --border:#1e1e30;
  --text:#e8e8f0; --muted:#555570;
}
html, body { width:100%; height:100%; background:#000; overflow:hidden; font-family:-apple-system,system-ui,sans-serif; -webkit-tap-highlight-color:transparent; }

/* â”€â”€ TOPBAR â”€â”€ */
#topbar { position:fixed; top:0; left:0; right:0; height:44px; background:var(--bar); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 0.5rem; gap:0.35rem; z-index:9999; }
.tb { border-radius:6px; cursor:pointer; font-size:0.68rem; font-weight:600; padding:0.28rem 0.55rem; display:flex; align-items:center; gap:0.25rem; white-space:nowrap; flex-shrink:0; text-decoration:none; border:1px solid; -webkit-tap-highlight-color:transparent; }
#btn-back   { background:rgba(255,60,120,0.1);  border-color:rgba(255,60,120,0.35); color:var(--accent); }
#btn-orient { background:rgba(123,47,247,0.1);  border-color:rgba(123,47,247,0.35); color:var(--purple); }
#btn-fs     { background:rgba(0,229,255,0.08);  border-color:rgba(0,229,255,0.25);  color:var(--cyan); font-size:0.95rem; }
#btn-log    { background:rgba(255,179,0,0.1);   border-color:rgba(255,179,0,0.3);   color:var(--yellow); }
#btn-back:active   { background:var(--accent); color:#000; }
#btn-orient:active { background:var(--purple); color:#fff; }
#btn-fs:active     { background:var(--cyan);   color:#000; }
#btn-log:active    { background:var(--yellow);  color:#000; }
#game-title { flex:1; font-size:0.72rem; font-weight:600; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; min-width:0; }

/* â”€â”€ GAME AREA â”€â”€ */
#game-area { position:fixed; top:44px; left:0; right:0; bottom:0; background:#000; display:flex; align-items:center; justify-content:center; }
/* EmulatorJS REQUIRES explicit px dimensions on the wrapper */
#ejs-wrapper { position:relative; background:#000; }
#game { width:100%; height:100%; }

/* â”€â”€ SPLASH â”€â”€ */
#splash { position:absolute; inset:0; background:#000; z-index:10; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.85rem; padding:1.5rem; text-align:center; }
.spin { width:44px; height:44px; border-radius:50%; border:3px solid #1a1a28; border-top-color:var(--accent); border-right-color:var(--purple); animation:spin 0.7s linear infinite; flex-shrink:0; }
@keyframes spin { to { transform:rotate(360deg); } }
#spl-status { font-family:monospace; font-size:0.56rem; color:var(--muted); letter-spacing:0.1em; }
#spl-bar-wrap { width:240px; max-width:80vw; height:6px; background:#111122; border-radius:3px; overflow:hidden; display:none; }
#spl-bar { height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--purple)); transition:width 0.2s; }
#spl-pct { font-family:monospace; font-size:0.58rem; color:var(--purple); min-height:1em; }

/* â”€â”€ LANDSCAPE (mobile only) â”€â”€ */
body.ls #topbar     { display:none; }
body.ls #float-back { display:flex; }
#float-back { display:none; position:fixed; z-index:9999; top:8px; left:8px; background:rgba(0,0,0,0.88); border:1px solid rgba(255,60,120,0.5); color:var(--accent); font-size:0.7rem; font-weight:700; padding:0.38rem 0.75rem; border-radius:6px; text-decoration:none; backdrop-filter:blur(6px); align-items:center; gap:0.3rem; }

/* â”€â”€ LOG PANEL â”€â”€ */
#log-panel { display:none; position:fixed; bottom:0; left:0; right:0; height:45vh; background:#05050e; border-top:2px solid var(--yellow); z-index:99999; flex-direction:column; }
#log-hdr { display:flex; align-items:center; justify-content:space-between; padding:4px 10px; background:#08081a; border-bottom:1px solid #1a1a28; flex-shrink:0; }
#log-hdr span { font-family:monospace; font-size:10px; color:var(--yellow); letter-spacing:0.1em; }
.lhb { font-size:10px; padding:2px 7px; border-radius:3px; cursor:pointer; border:1px solid; background:transparent; }
#log-list { flex:1; overflow-y:auto; padding:5px 10px; font-family:monospace; font-size:10.5px; line-height:1.7; }
.le { border-bottom:1px solid #0a0a18; word-break:break-all; }
.le .ts { opacity:0.3; margin-right:5px; font-size:9.5px; }
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <a  id="btn-back"   class="tb" href="gba-arcade.html">â† Libreria</a>
  <div id="game-title">...</div>
  <button id="btn-orient" class="tb" onclick="toggleLS()">âŸ³ Landscape</button>
  <button id="btn-fs"     class="tb" onclick="toggleFS()">â›¶</button>
  <button id="btn-log"    class="tb" onclick="toggleLog()">ğŸ› LOG</button>
</div>

<a id="float-back" href="gba-arcade.html">â† Esci</a>

<!-- LOG â€” MUST be in DOM before any script -->
<div id="log-panel">
  <div id="log-hdr">
    <span>ğŸ› DEBUG LOG</span>
    <div style="display:flex;gap:5px">
      <button class="lhb" onclick="document.getElementById('log-list').innerHTML=''" style="border-color:rgba(255,68,68,.4);color:#f44">CLEAR</button>
      <button class="lhb" onclick="toggleLog()" style="border-color:rgba(255,179,0,.4);color:var(--yellow)">âœ•</button>
    </div>
  </div>
  <div id="log-list"></div>
</div>

<!-- GAME AREA -->
<div id="game-area">
  <div id="ejs-wrapper">
    <div id="game"></div>
    <div id="splash">
      <div class="spin"></div>
      <div id="spl-status">Avvio...</div>
      <div id="spl-bar-wrap"><div id="spl-bar"></div></div>
      <div id="spl-pct"></div>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var P      = new URLSearchParams(location.search);
var ROMURL = P.get('url')   || '';
var TITLE  = P.get('title') || 'GBA Game';
var FNAME  = decodeURIComponent(ROMURL.split('/').pop()); /* original filename with extension */

document.getElementById('game-title').textContent = TITLE;
document.title = TITLE;

/* Wrapper must have explicit px size for EmulatorJS */
function sizeWrap() {
  var W = window.innerWidth, H = window.innerHeight - 44, R = 3/2, w, h;
  if (W/H > R) { h=H; w=Math.round(h*R); } else { w=W; h=Math.round(w/R); }
  var wr = document.getElementById('ejs-wrapper');
  wr.style.width = w+'px'; wr.style.height = h+'px';
}
sizeWrap();
window.addEventListener('resize', sizeWrap);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var logList = document.getElementById('log-list');
var logOpen = false;
function log(msg, type) {
  var C = {ok:'#00ffa0', err:'#ff4444', warn:'#ffb300', info:'#00c8ff'};
  var t = new Date().toLocaleTimeString('it',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  var d = document.createElement('div');
  d.className = 'le'; d.style.color = C[type]||'#aaa';
  d.innerHTML = '<span class="ts">'+t+'</span>'+msg;
  logList.appendChild(d); logList.scrollTop = logList.scrollHeight;
}
function toggleLog() {
  logOpen = !logOpen;
  document.getElementById('log-panel').style.display = logOpen ? 'flex' : 'none';
  document.getElementById('btn-log').textContent = logOpen ? 'âœ• LOG' : 'ğŸ› LOG';
}
/* Catch all errors */
window.addEventListener('error', function(e) { log('âŒ '+e.message+' ['+((e.filename||'').split('/').pop())+':'+e.lineno+']','err'); });
window.addEventListener('unhandledrejection', function(e) { log('âŒ '+(e.reason&&(e.reason.message||e.reason)),'err'); });
var _ce=console.error; console.error=function(){ var m=Array.from(arguments).join(' '); log('âŒ '+m,'err'); _ce.apply(console,arguments); };
var _cw=console.warn;  console.warn =function(){ var m=Array.from(arguments).join(' ');
  /* silence known noise */
  if (/gameId|deprecated|EJS_gameID/i.test(m)) return;
  log('âš  '+m,'warn'); _cw.apply(console,arguments);
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function status(msg) { document.getElementById('spl-status').textContent = msg; }
function setBar(pct) {
  document.getElementById('spl-bar-wrap').style.display = 'block';
  document.getElementById('spl-bar').style.width = pct+'%';
  document.getElementById('spl-pct').textContent = pct > 0 ? pct+'%' : '';
}
function showError(msg) {
  document.querySelector('.spin').style.display = 'none';
  status('âŒ '+msg);
  document.getElementById('spl-pct').style.color = '#f44';
  document.getElementById('spl-pct').textContent = 'Apri LOG ğŸ› per dettagli';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORIENTATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var isLS = false;
function toggleLS() {
  isLS = !isLS;
  document.body.classList.toggle('ls', isLS);
  document.getElementById('btn-orient').textContent = isLS ? 'âŸ³ Portrait' : 'âŸ³ Landscape';
  log('ğŸ”„ '+(isLS?'Landscape':'Portrait'),'info');
  var area = document.getElementById('game-area');
  var wr   = document.getElementById('ejs-wrapper');
  if (isLS && window.innerWidth < 769) {
    var lw = window.innerHeight, lh = window.innerWidth;
    area.style.cssText = 'position:fixed;top:0;left:0;background:#000;display:flex;align-items:center;justify-content:center;width:'+lw+'px;height:'+lh+'px;transform-origin:top left;transform:rotate(90deg) translateX(0) translateY(-100%);';
    var rw = Math.min(lw, Math.round(lh*1.5)), rh = Math.round(rw/1.5);
    wr.style.width = rw+'px'; wr.style.height = rh+'px';
    try { screen.orientation.lock('landscape').catch(function(){}); } catch(e){}
  } else {
    area.style.cssText = 'position:fixed;top:44px;left:0;right:0;bottom:0;background:#000;display:flex;align-items:center;justify-content:center;';
    sizeWrap();
    try { screen.orientation.unlock(); } catch(e){}
  }
}
function toggleFS() {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(function(){});
  else document.exitFullscreen();
}
document.addEventListener('fullscreenchange', function() {
  document.getElementById('btn-fs').textContent = document.fullscreenElement ? 'âœ•' : 'â›¶';
  sizeWrap();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMULATORJS LAUNCHER
   Called once we have a valid blob URL.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function launchEJS(blobUrl) {
  log('â–¶ Lancio EmulatorJS...','info');
  status('Avvio emulatore...');

  /*
    IMPORTANT FIXES applied here:
    1. EJS_gameName = original filename with extension (.zip)
       Without this, EJS doesn't know it's a zip and crashes.
    2. EJS_gameID set to avoid "not set" warnings.
    3. All vars as window.* so EJS finds them globally.
  */
  window.EJS_player          = '#game';
  window.EJS_core            = 'mgba';
  window.EJS_gameUrl         = blobUrl;
  window.EJS_gameName        = FNAME;          /* â† CRITICAL: filename with .zip ext */
  window.EJS_gameID          = TITLE.replace(/[^a-z0-9]/gi,'_').toLowerCase();
  window.EJS_pathtodata      = 'https://cdn.emulatorjs.org/stable/data/';
  window.EJS_startOnLoaded   = true;
  window.EJS_color           = '#7b2ff7';
  window.EJS_backgroundColor = '#000000';
  window.EJS_language        = 'en';
  window.EJS_AdUrl           = '';
  window.EJS_disableLocalStorage = false;

  window.EJS_onGameStart = function() {
    log('ğŸ® GIOCO AVVIATO!','ok');
    document.getElementById('splash').style.display = 'none';
  };
  window.EJS_onLoadError = function(e) {
    log('âŒ EJS_onLoadError: '+(e||'?'),'err');
    showError('Errore emulatore');
  };

  log('ğŸ“¦ CDN: '+window.EJS_pathtodata,'info');
  log('ğŸ“„ gameName: '+window.EJS_gameName,'info');

  var s = document.createElement('script');
  s.src = window.EJS_pathtodata+'loader.js';
  s.onload  = function() { log('âœ… loader.js caricato','ok'); };
  s.onerror = function() { log('âŒ loader.js FAIL','err'); showError('CDN non raggiungibile'); };
  document.head.appendChild(s);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROM DOWNLOADER â€” async waterfall
   Tries each method. Skips to next if:
   â€¢ network error
   â€¢ HTTP status not ok
   â€¢ body < 10 KB (empty/corrupt)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
log('â”â”â” START â”â”â”','info');
log('ğŸ® '+TITLE,'info');
log('ğŸ“„ File: '+FNAME,'info');

/* Build proxy/method list */
function getMethods(url) {
  return [
    { name:'codetabs',     url: 'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(url) },
    { name:'corsproxy.io', url: 'https://corsproxy.io/?'+encodeURIComponent(url) },
    { name:'allorigins',   url: 'https://api.allorigins.win/raw?url='+encodeURIComponent(url) },
    { name:'thingproxy',   url: 'https://thingproxy.freeboard.io/fetch/'+url },
    { name:'diretto',      url: url }
  ];
}

/* Stream response into Blob with progress bar. Returns Blob or throws. */
async function streamToBlob(res, name) {
  var total = 0;
  try { total = parseInt(res.headers.get('content-length')||'0')||0; } catch(e){}
  if (total) log('ğŸ“¦ Dimensione: '+(total/1048576).toFixed(1)+' MB','info');

  var reader   = res.body.getReader();
  var chunks   = [];
  var received = 0;

  while (true) {
    var chunk = await reader.read();
    if (chunk.done) break;
    chunks.push(chunk.value);
    received += chunk.value.length;
    if (total > 0) {
      var pct = Math.round(received/total*100);
      setBar(pct);
      status('Download via '+name+': '+pct+'%');
    } else {
      status('Download via '+name+': '+(received/1048576).toFixed(1)+' MB...');
    }
  }

  log('ğŸ“Š Ricevuti: '+(received/1048576).toFixed(2)+' MB','info');

  /* Minimum size check: GBA ROMs are at least 32 KB */
  if (received < 10240) {
    throw new Error('Body troppo piccolo ('+received+' bytes) â€” probabilmente un redirect vuoto');
  }

  log('âœ… Download OK: '+(received/1048576).toFixed(1)+' MB','ok');
  return new Blob(chunks);
}

async function downloadROM() {
  if (!ROMURL) { log('âŒ Nessuna URL','err'); showError('Nessuna ROM specificata'); return; }

  var methods = getMethods(ROMURL);
  setBar(0);

  for (var i = 0; i < methods.length; i++) {
    var m = methods[i];
    log('ğŸ“¡ ['+(i+1)+'/'+methods.length+'] Tentativo: '+m.name,'info');
    status('Download via '+m.name+'...');

    try {
      var res = await fetch(m.url, { mode:'cors' });

      if (!res.ok) {
        throw new Error('HTTP '+res.status+' '+res.statusText);
      }
      if (!res.body) {
        throw new Error('Response body null');
      }

      var blob    = await streamToBlob(res, m.name);
      var blobUrl = URL.createObjectURL(blob);
      log('ğŸ”— Blob URL creato ('+m.name+')','ok');
      launchEJS(blobUrl);
      return; /* â† success, stop loop */

    } catch (e) {
      log('âš  '+m.name+' fallito: '+e.message,'warn');
      /* continue to next method */
    }
  }

  log('âŒ Tutti i '+methods.length+' metodi falliti','err');
  showError('CORS bloccato su tutti i proxy');
}

downloadROM();
</script>
</body>
</html>
