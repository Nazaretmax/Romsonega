<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>GBA Player</title>
<style>
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }

html, body {
  width:100%; height:100%;
  background:#000;
  overflow:hidden;
  font-family:-apple-system, system-ui, sans-serif;
  -webkit-tap-highlight-color:transparent;
  user-select:none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME FILLS ENTIRE SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#ejs-wrapper {
  position:fixed;
  inset:0;
  background:#000;
  /* EmulatorJS needs explicit px â€” set by JS */
}
#game {
  width:100%;
  height:100%;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING SCREEN
   Shown while ROM is downloading
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#splash {
  position:fixed; inset:0;
  background:#000;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:1.2rem; z-index:100;
  padding:2rem;
}
.spin {
  width:48px; height:48px; border-radius:50%;
  border:3px solid #111122;
  border-top-color:#ff3c78;
  border-right-color:#7b2ff7;
  animation:spin .7s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

#spl-title {
  font-size:clamp(0.8rem, 2.5vw, 1.1rem);
  font-weight:600; color:#e8e8f0;
  text-align:center;
  max-width:80vw;
  overflow:hidden; text-overflow:ellipsis;
  white-space:nowrap;
}
#spl-status {
  font-family:monospace;
  font-size:0.62rem; letter-spacing:0.1em;
  color:#555570; text-align:center;
}
#spl-bar-wrap {
  width:min(260px, 70vw); height:5px;
  background:#111122; border-radius:3px; overflow:hidden;
  display:none;
}
#spl-bar {
  height:100%; width:0%;
  background:linear-gradient(90deg,#ff3c78,#7b2ff7);
  transition:width .2s;
  border-radius:3px;
}
#spl-pct {
  font-family:monospace; font-size:0.6rem;
  color:#7b2ff7; min-height:1em;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLOATING HUD
   Appears on hover/tap, auto-hides
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#hud {
  position:fixed; top:0; left:0; right:0;
  height:44px;
  display:flex; align-items:center;
  padding:0 0.6rem; gap:0.4rem;
  z-index:500;
  background:linear-gradient(to bottom, rgba(0,0,0,0.75) 0%, transparent 100%);
  backdrop-filter:blur(0px);
  opacity:0;
  transition:opacity 0.3s;
  pointer-events:none;
}
/* Show HUD on hover (PC) */
body:hover #hud,
/* Show HUD when active (touch) */
#hud.visible {
  opacity:1;
  pointer-events:all;
}
/* Always show if splash visible */
body.loading #hud { display:none; }

.hb {
  border-radius:6px; cursor:pointer;
  font-size:0.68rem; font-weight:600;
  padding:0.28rem 0.6rem;
  display:flex; align-items:center; gap:0.25rem;
  white-space:nowrap; flex-shrink:0;
  text-decoration:none;
  background:rgba(0,0,0,0.6);
  border:1px solid rgba(255,255,255,0.12);
  color:rgba(255,255,255,0.85);
  backdrop-filter:blur(8px);
  transition:background .15s, border-color .15s;
}
.hb:active, .hb:hover { background:rgba(255,255,255,0.15); border-color:rgba(255,255,255,0.3); }

#hud-title {
  flex:1; font-size:0.72rem; font-weight:600;
  color:rgba(255,255,255,0.7);
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  min-width:0;
}

</style>
</head>
<body class="loading">


<!-- LOADING SCREEN -->
<div id="splash">
  <div class="spin"></div>
  <div id="spl-title">...</div>
  <div id="spl-status">Avvio...</div>
  <div id="spl-bar-wrap"><div id="spl-bar"></div></div>
  <div id="spl-pct"></div>
</div>

<!-- GAME FILLS SCREEN -->
<div id="ejs-wrapper">
  <div id="game"></div>
</div>

<!-- FLOATING HUD (auto-hide) -->
<div id="hud">
  <a  id="hud-back" class="hb" href="gba-arcade.html">â† Libreria</a>
  <div id="hud-title"></div>
  <button class="hb" onclick="toggleFS()" id="btn-fs">â›¶</button>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARAMS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var P      = new URLSearchParams(location.search);
var ROMURL = P.get('url')   || '';
var TITLE  = P.get('title') || 'GBA Game';
var FNAME  = decodeURIComponent(ROMURL.split('/').pop());

document.getElementById('spl-title').textContent  = TITLE;
document.getElementById('hud-title').textContent  = TITLE;
document.title = TITLE;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WRAPPER SIZING
   EmulatorJS requires EXPLICIT px on wrapper.
   We fill the entire screen.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sizeWrap() {
  var wr = document.getElementById('ejs-wrapper');
  wr.style.width  = window.innerWidth  + 'px';
  wr.style.height = window.innerHeight + 'px';
}
sizeWrap();
window.addEventListener('resize', sizeWrap);


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HUD AUTO-HIDE
   Touch: show for 3s then hide
   PC:    CSS hover handles it
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var hudTimer;
function showHUD() {
  var hud = document.getElementById('hud');
  hud.classList.add('visible');
  clearTimeout(hudTimer);
  hudTimer = setTimeout(function(){ hud.classList.remove('visible'); }, 3000);
}
document.addEventListener('touchstart', showHUD, {passive:true});
document.addEventListener('mousemove',  showHUD);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FULLSCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function tryFullscreen() {
  var el = document.documentElement;
  var req = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen;
  if (req) req.call(el).catch(function(){});
}
function toggleFS() {
  if (document.fullscreenElement || document.webkitFullscreenElement) {
    (document.exitFullscreen || document.webkitExitFullscreen || function(){}).call(document);
  } else {
    tryFullscreen();
  }
}
document.addEventListener('fullscreenchange',       function(){ document.getElementById('btn-fs').textContent=document.fullscreenElement?'âœ•':'â›¶'; sizeWrap(); });
document.addEventListener('webkitfullscreenchange', function(){ document.getElementById('btn-fs').textContent=document.webkitFullscreenElement?'âœ•':'â›¶'; sizeWrap(); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPLASH HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function splStatus(msg) { document.getElementById('spl-status').textContent = msg; }
function splBar(pct) {
  document.getElementById('spl-bar-wrap').style.display='block';
  document.getElementById('spl-bar').style.width=pct+'%';
  document.getElementById('spl-pct').textContent=pct>0?pct+'%':'';
}
function splError(msg) {
  document.querySelector('.spin').style.display='none';
  splStatus('âŒ '+msg);
  document.getElementById('spl-pct').style.color='#f44';
  document.getElementById('spl-pct').textContent='Apri LOG ğŸ› per dettagli';
}
function hideSplash() {
  document.getElementById('splash').style.display='none';
  document.body.classList.remove('loading');
  /* Auto fullscreen when game starts */
  setTimeout(tryFullscreen, 300);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMULATORJS LAUNCHER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function launchEJS(blobUrl) {
  log('â–¶ Lancio EmulatorJS...','info');
  splStatus('Avvio emulatore...');

  window.EJS_player          = '#game';
  window.EJS_core            = 'mgba';
  window.EJS_gameUrl         = blobUrl;
  window.EJS_gameName        = FNAME;   /* CRITICAL: needed so EJS knows it's a .zip */
  window.EJS_gameID          = TITLE.replace(/[^a-z0-9]/gi,'_').toLowerCase();
  window.EJS_pathtodata      = 'https://cdn.emulatorjs.org/stable/data/';
  window.EJS_startOnLoaded   = true;
  window.EJS_color           = '#7b2ff7';
  window.EJS_backgroundColor = '#000000';
  window.EJS_language        = 'en';
  window.EJS_AdUrl           = '';

  window.EJS_onGameStart = function() {
    log('ğŸ® GIOCO AVVIATO!','ok');
    hideSplash();
  };
  window.EJS_onLoadError = function(e) {
    log('âŒ EJS_onLoadError: '+(e||'?'),'err');
    splError('Errore emulatore');
  };

  log('ğŸ“„ gameName: '+window.EJS_gameName,'info');

  var s = document.createElement('script');
  s.src = window.EJS_pathtodata+'loader.js';
  s.onload  = function(){ log('âœ… loader.js OK','ok'); };
  s.onerror = function(){ log('âŒ loader.js FAIL','err'); splError('CDN non raggiungibile'); };
  document.head.appendChild(s);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROM DOWNLOADER â€” async waterfall
   codetabs first (most reliable in tests)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getMethods(url) {
  return [
    { name:'codetabs',     url:'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(url) },
    { name:'corsproxy.io', url:'https://corsproxy.io/?'+encodeURIComponent(url) },
    { name:'allorigins',   url:'https://api.allorigins.win/raw?url='+encodeURIComponent(url) },
    { name:'thingproxy',   url:'https://thingproxy.freeboard.io/fetch/'+url },
    { name:'diretto',      url:url }
  ];
}

async function streamToBlob(res, name) {
  var total = 0;
  try { total = parseInt(res.headers.get('content-length')||'0')||0; } catch(e){}
  if (total) log('ğŸ“¦ '+(total/1048576).toFixed(1)+' MB','info');

  var reader=res.body.getReader(), chunks=[], received=0;
  while (true) {
    var c = await reader.read();
    if (c.done) break;
    chunks.push(c.value); received+=c.value.length;
    if (total>0) { var p=Math.round(received/total*100); splBar(p); splStatus(name+': '+p+'%'); }
    else          { splStatus(name+': '+(received/1048576).toFixed(1)+' MB...'); }
  }

  log('ğŸ“Š Ricevuti: '+(received/1048576).toFixed(2)+' MB','info');
  if (received < 10240) throw new Error('Body vuoto ('+received+' bytes)');
  log('âœ… Download OK','ok');
  return new Blob(chunks);
}

async function downloadROM() {
  if (!ROMURL) { splError('Nessuna ROM'); return; }
  log('â”â”â” START â”â”â”','info');
  log('ğŸ® '+TITLE,'info');
  log('ğŸ“„ '+FNAME,'info');

  splBar(0);
  var methods = getMethods(ROMURL);

  for (var i=0; i<methods.length; i++) {
    var m = methods[i];
    log('ğŸ“¡ ['+(i+1)+'/'+methods.length+'] '+m.name,'info');
    splStatus('Download: '+m.name+'...');
    try {
      var res = await fetch(m.url, {mode:'cors'});
      if (!res.ok)   throw new Error('HTTP '+res.status);
      if (!res.body) throw new Error('Body null');
      var blob    = await streamToBlob(res, m.name);
      var blobUrl = URL.createObjectURL(blob);
      log('ğŸ”— Blob pronto via '+m.name,'ok');
      launchEJS(blobUrl);
      return;
    } catch(e) {
      log('âš  '+m.name+': '+e.message,'warn');
    }
  }
  log('âŒ Tutti i metodi falliti','err');
  splError('CORS bloccato â€” prova da PC o altra rete');
}

downloadROM();
</script>
</body>
</html>
